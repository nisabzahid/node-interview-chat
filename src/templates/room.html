<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Chat Room</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css"
    />
    <link rel="stylesheet" href="/static/room.css" />
  </head>
  <body>
    <div class="block left-block">
      <h4 class="text-center">Active Users</h4>
      <div class="d-flex justify-content-center">
        <button class="btn btn-sm btn-danger m-2" id="leave-chat">
          Leave Chat
        </button>
      </div>
      <ul id="active-user-list"></ul>
    </div>

    <div class="block middle-block">
      <h4 style="text-align:center">Conversations</h4>

      <ul id="message-list" style="padding: 5px;"></ul>

      <div id="form-container">
        <form action="" id="conversation-form">
          <input type="text" id="input-message" placeholder="Your message" />
          <button>Send</button>
        </form>
      </div>
    </div>

    <div class="block right-block">
      <h4 style="text-align: center;">Problems</h4>

      <div id="problem-list"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https:////cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/static/drawdown.js"></script>
    <script>
      $(() => {
        if (sessionStorage.getItem("user") === null) {
          alert("you are not logged in");
          window.location.replace("/");
        }
      });
      let user = JSON.parse(sessionStorage.getItem("user"));

      var socket = io.connect("/room");
      if (socket === null) {
        alert("connection error");
        window.location.replace("/");
      }

      const ChatEntry = "chat entry";
      const NewMessage = "message";
      const Disconnect = "disconnect";
      const PreviousMessages = "previous messages";
      const ActiveUsers = "active users";

      socket.emit(ChatEntry, user);

      const displayNewMessage = msg => {
        // filter markdown in message body
        let messageBody = msg.body.split("#").join("");
        let fullMessage = markdown(`**${msg.username}** ${messageBody}`);

        $("#message-list").append($("<li>").append($("<p>").html(fullMessage)));
        highlightCode();
      };

      const displayActiveUser = user => {
        $("#active-user-list").append(
          $("<li>").append(user.name, $("<br>"), $("<span>").text(user.type))
        );
      };

      const scrollToTop = element => {
        $(element).animate({ scrollTop: $(element)[0].scrollHeight }, 1000);
      };

      // display all previous messages
      socket.on(PreviousMessages, arr => {
        arr.forEach(msg => {
          displayNewMessage(msg);
        });
        scrollToTop("#message-list");
      });

      socket.on(NewMessage, msg => {
        displayNewMessage(msg);
        scrollToTop("#message-list");
      });

      socket.on(Disconnect, () => {
        alert("you are disconnected");
        window.location.replace("/");
      });

      socket.on(ActiveUsers, users => {
        $("#active-user-list").empty();
        users.forEach(user => {
          displayActiveUser(user);
        });
      });

      $("#conversation-form").submit(e => {
        e.preventDefault();
        let message = {
          username: user.name,
          body: $("#input-message").val(),
          time: new Date().toLocaleString()
        };
        socket.emit(NewMessage, message);
        $("#input-message").val("");
        return false;
      });

      $("#leave-chat").on("click", event => {
        sessionStorage.clear();
        try {
          socket.disconnect();
        } catch (err) {
          window.location.replace("/");
        }
      });
    </script>

    <script>
      const PinnedProblems = "pinned problems";
      const AddProblem = "add problem";
      const AddSolution = "add solution";
      const UpdateProblem = "update problem";
      // const user = JSON.parse(sessionStorage.getItem("user"));

      $(() => {
        let currentUser = JSON.parse(sessionStorage.getItem("user"));
        if (currentUser.type.toLowerCase() === "interviewer") {
          placeAddProblemForm();
          return;
        }
      });

      // display pinned problems
      socket.on(PinnedProblems, arr => {
        arr.forEach(problem => {
          addNewProblemInDOM(problem);
          if (problem.solutions.length > 0) {
            problem.solutions.forEach(solution => {
              addSolutionInDOM(problem.id, solution);
            });
          }
        });
      });

      const placeAddProblemForm = () => {
        $("#problem-list").append(
          $("<form>")
            .attr("id", "add-problem-form")
            .attr("action", "")
            .submit(event => createProblemHandler(event))
            .append(
              $("<input>")
                .attr("id", "input-new-problem")
                .attr("type", "text")
                .attr("class", "form-control")
                .attr("placeholder", "Your Problem"),
              $("<button>")
                .attr("class", "btn btn-success")
                .text("Add Problem")
            )
        );
      };

      const generateRandomString = () => {
        let characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        let charactersLength = characters.length;
        var result = "";
        for (var i = 0; i < 10; i++) {
          result += characters.charAt(
            Math.floor(Math.random() * charactersLength)
          );
        }
        return result;
      };

      /*

      ID pattern:

      problem-list
      problem-id-${id}
      solutions-${problem_id}
      solution-${solution_id}-${problem_id}
      */

      const highlightCode = () => {
        var pres = document.querySelectorAll("pre>code");
        for (var i = 0; i < pres.length; i++) {
          hljs.highlightBlock(pres[i]);
        }
      };

      const runCodeScript = (lang, code) => {
        try {
          if (lang.toLowerCase() === "javascript") {
            alert(eval(code));
            return;
          } else if (lang.toLowerCase() === "python") {
            let body = JSON.stringify({ code: code });
            axios
              .post("http://localhost:3000/runtime/py", body, {
                headers: { "Content-Type": "application/json" }
              })
              .then(res => {
                alert(res.data.result);
              })
              .catch(err => {
                alert("runtime error");
              });
          }
        } catch (err) {
          alert("runtime error");
        }
      };

      const addSolutionInDOM = (problemId, solution) => {
        let preview = $("<li>")
          .attr("class", "list-group-item")
          .append(
            $("<pre>")
              .attr("class", "prettyprint")
              .append(
                $("<code>")
                  .dblclick(event => {
                    let selectedText = window.getSelection().focusNode.data;
                    let previousText = $("#input-message").val();
                    $("#input-message").val(
                      `${previousText} \`${selectedText}\``
                    );
                  })
                  .text(solution.code)
                  .attr("class", `language-${solution.lang}`)
              ),

            $("<small>").text(
              `${solution.lang} by ${solution.author} at ${solution.time}`
            ),
            $("<button>")
              .text("Run")
              .attr("class", "btn btn-success btn-sm float-right")
              .click(event => {
                runCodeScript(solution.lang, solution.code);
              })
          );

        $(`#solutions-${problemId}`).append(preview);
        highlightCode();
      };

      const problemSolutionHandler = problem => {
        event.preventDefault();
        let code = $(`#${problem.id}-solution-code`).val();
        if (code === "") {
          alert("You must give a piece of code");
          return;
        }
        let lang = $(`#${problem.id}-solution-lang`).val();
        $(`#${problem.id}-solution-code`).val("");

        let solution = {
          code: code,
          lang: lang,
          author: user.name,
          time: new Date().toLocaleString()
        };
        socket.emit(AddSolution, { problemId: problem.id, solution });
      };

      const buildSolutionFormOn = problem => {
        return $("<form>")
          .attr("id", `${problem.id}-solution-form`)
          .submit(event => problemSolutionHandler(problem))
          .append(
            $("<textarea>")
              .attr("style", "width:100%;")
              .attr("class", "form-control")
              .attr("placeholder", "Your solution")
              .attr("id", `${problem.id}-solution-code`),

            $("<select>")
              .attr("class", "form-control")
              .attr("id", `${problem.id}-solution-lang`)
              .append(
                $("<option>")
                  .attr("value", "javascript")
                  .text("JavaScript"),
                $("<option>")
                  .attr("value", "python")
                  .text("Python")
              ),

            $("<button>")
              .attr("class", "btn btn-primary")
              .text("Submit")
          );
      };

      const addNewProblemInDOM = problem => {
        let card = $("<div>");

        let header = $("<div>")
          .addClass("card-header")
          .append(
            $("<a>")
              .attr("class", "card-link")
              .attr("data-toggle", "collapse")
              .attr("aria-expanded", "false")
              .attr("href", `#${problem.id}`)
              .attr("id", `problem-id-${problem.id}`)
              .text(`${problem.question} - set by ${problem.author}`)
          );

        if (problem.author === user.name) {
          header.append(
            $("<button>")
              .attr("class", "btn btn-sm btn-primary ml-2")
              .text("edit")
              .click(event => {
                problemUpdateHandler(problem, event);
              })
          );
        }

        let solutionForm = buildSolutionFormOn(problem);

        let body = $("<div>")
          .attr("id", `${problem.id}`)
          .attr("class", "collapse hide")
          .attr("data-parent", "#problem-list")
          .append(
            $("<div>")
              .attr("class", "card-body")
              .append(
                $("<ul>")
                  .attr("class", "list-group")
                  .attr("id", `solutions-${problem.id}`),
                solutionForm
              )
          );
        card.append(header, body);
        $("#problem-list").prepend(card);
      };

      const problemUpdateHandler = (problem, event) => {
        event.preventDefault();
        let updatedQuestion = prompt("Update", problem.question);
        if (updatedQuestion !== null) {
          problem.question = updatedQuestion;
          socket.emit(UpdateProblem, problem);
          alert("Updated");
        }
      };

      const createProblemHandler = event => {
        event.preventDefault();
        let question = $("#input-new-problem").val();
        question = question.trim();
        if (question === "") {
          alert("You should type any statement");
          return;
        }

        let problem = {
          id: generateRandomString(),
          question: question,
          time: new Date().toLocaleString(),
          author: user.name,
          solutions: []
        };

        // broadcast this problem
        socket.emit(AddProblem, problem);

        $("#input-new-problem").val("");
      };

      const updateProblemInDOM = problem => {
        $(`#problem-id-${problem.id}`).text(
          `${problem.question} - set by ${problem.author}`
        );
      };

      // receive new problem
      socket.on(AddProblem, msg => {
        addNewProblemInDOM(msg);
      });

      // receive a new solution of a problem
      socket.on(AddSolution, msg => {
        addSolutionInDOM(msg.problemId, msg.solution);
      });

      socket.on(UpdateProblem, msg => {
        updateProblemInDOM(msg);
      });
    </script>
  </body>
</html>
