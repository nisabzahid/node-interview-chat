<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Chat Room</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css"
    />
    <link rel="stylesheet" href="/static/room.css" />
  </head>
  <body>
    <div class="block left-block">
      <h4 class="text-center">Active Users</h4>
      <div class="d-flex justify-content-center" id="room-actions">
        <button class="btn btn-sm btn-danger m-2" id="leave-chat">
          Leave Chat
        </button>
      </div>
      <ul id="active-user-list"></ul>
    </div>

    <div class="block middle-block">
      <h4 style="text-align: center;">Conversations</h4>

      <ul id="message-list" style="padding: 5px;"></ul>

      <div id="form-container">
        <form action="" id="conversation-form">
          <input type="text" id="input-message" placeholder="Your message" />
          <button>Send</button>
        </form>
      </div>
    </div>

    <div class="block right-block">
      <h4 style="text-align: center;">Problems</h4>

      <div id="problem-list"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https:////cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
    <script src="/static/highlight-line.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/static/drawdown.js"></script>

    <!-- static functions -->
    <script>
      const scrollToTop = (element) => {
        $(element).animate({ scrollTop: $(element)[0].scrollHeight }, 1000);
      };

      const generateRandomString = () => {
        let characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        let charactersLength = characters.length;
        var result = "";
        for (var i = 0; i < 10; i++) {
          result += characters.charAt(
            Math.floor(Math.random() * charactersLength)
          );
        }
        return result;
      };

      const highlightCode = () => {
        var pres = document.querySelectorAll("pre>code");
        for (var i = 0; i < pres.length; i++) {
          hljs.highlightBlock(pres[i]);
          hljs.lineNumbersBlock(pres[i]);
        }
      };

      const runCodeScript = (lang, code, problemId) => {
        var url = "http://localhost:3000/runtime";
        if (lang.toLowerCase() === "javascript") {
          url = url + "/js/";
        } else if (lang.toLowerCase() === "python") {
          url = url + "/py/";
        } else {
          return;
        }
        let body = JSON.stringify({ code: code, problemId: problemId });
        let config = {
          headers: { "Content-Type": "application/json" },
        };
        axios
          .post(url, body, config)
          .then((res) => {
            if (res.data.result.status === undefined) {
              alert(res.data.result);
              return;
            }
            let data = res.data.result;
            alert(
              "Actual: " +
                data.actual +
                "\nFound: " +
                data.found +
                "\nStatus: " +
                data.status
            );
          })
          .catch((err) => {
            alert("Runtime Error");
          });
      };

      const onCodeLineSelect = (event) => {
        try {
          let code = event.target.getAttribute("codeline");
          if (code !== "") {
            let previousText = $("#input-message").val();
            $("#input-message").val(previousText + " `" + code + "`");
          }
        } catch (err) {
          alert("unable to copy code line");
        }
      };
    </script>

    <!-- Driver -->
    <script>
      var Startup = {
        isLoaded: false,
        Loaders: {},
        Binders: {},
      };
      var user;
      $(() => {
        // startup loaders
        Startup.Loaders.log();
        Startup.isLoaded = true;
        // binders
        Startup.Binders.onWriteMessage();
        Startup.Binders.onLeaveRoom();
        let _user = JSON.parse(sessionStorage.getItem("user"));
        if (_user.type === "Creator") {
          Startup.Binders.placeProblemCreateForm();
          Startup.Binders.placeRoomDismissButton();
          return;
        }
      });
      user = JSON.parse(sessionStorage.getItem("user"));

      var DOM = {
        Conversation: {},
        Problem: {},
        Peoples: {},
      };

      var Handlers = {
        Problem: {},
      };

      var Builders = {
        Form: {},
        Block: {},
      };

      let API = {};

      var socket = io.connect("/room");
      if (socket === null) {
        alert("connection error");
        window.location.replace("/");
      }

      const ChatEntry = "chat entry";
      const NewMessage = "message";
      const Disconnect = "disconnect";
      const PreviousMessages = "previous messages";
      const ActiveUsers = "active users";
      const PinnedProblems = "pinned problems";
      const AddProblem = "add problem";
      const AddSolution = "add solution";
      const UpdateProblem = "update problem";
      const RoomDismiss = "room dismiss";

      socket.emit(ChatEntry, user);

      // load from API
      socket.on(PreviousMessages, (arr) => {
        arr.forEach((msg) => {
          DOM.Conversation.message(msg);
        });
        scrollToTop("#message-list");
      });

      socket.on(NewMessage, (msg) => {
        DOM.Conversation.message(msg);
        scrollToTop("#message-list");
      });

      socket.on(Disconnect, () => {
        alert("you are disconnected");
        window.location.replace("/");
      });

      socket.on(ActiveUsers, (users) => {
        $("#active-user-list").empty();
        users.forEach((user) => {
          DOM.Peoples.active(user);
        });
      });

      // receive new problem
      socket.on(AddProblem, (msg) => {
        DOM.Problem.create(msg);
      });

      // receive a new solution of a problem
      socket.on(AddSolution, (msg) => {
        DOM.Problem.solution(msg.problemId, msg.solution);
      });

      socket.on(PinnedProblems, (arr) => {
        arr.forEach((problem) => {
          DOM.Problem.create(problem);
          if (problem.solutions.length > 0) {
            problem.solutions.forEach((solution) => {
              DOM.Problem.solution(problem.id, solution);
            });
          }
        });
      });

      socket.on(UpdateProblem, (msg) => {
        DOM.Problem.update(msg);
      });
    </script>

    <!-- Startup loader and binder binders -->
    <script>
      Startup.Loaders.log = () => {
        if (sessionStorage.getItem("user") === null) {
          alert("you are not logged in");
          window.location.replace("/");
        }
      };

      Startup.Binders.onWriteMessage = () => {
        $("#conversation-form").submit((e) => {
          e.preventDefault();
          let value = $("#input-message").val();
          if (value === "") {
            return;
          }
          let message = {
            username: user.name,
            body: value,
            time: new Date().toLocaleString(),
          };
          socket.emit(NewMessage, message);
          $("#input-message").val("");
          return false;
        });
      };

      Startup.Binders.onLeaveRoom = () => {
        $("#leave-chat").text(`${user.name} Leave`);
        $("#leave-chat").on("click", (event) => {
          sessionStorage.clear();
          try {
            socket.disconnect();
          } catch (err) {
            window.location.replace("/");
          }
        });
      };

      Startup.Binders.placeProblemCreateForm = () => {
        $("#problem-list").append(
          $("<form>")
            .attr("id", "add-problem-form")
            .attr("action", "")
            .submit((event) => Handlers.Problem.create(event))
            .append(
              $("<input>")
                .attr("id", "input-new-problem")
                .attr("type", "text")
                .attr("class", "form-control")
                .attr("placeholder", "Your Problem"),
              $("<textarea>")
                .attr("class", "form-control")
                .attr("id", "input-problem-test-cases")
                .attr("placeholder", "Problem Test Cases"),
              $("<button>")
                .attr("class", "btn btn-success btn-sm")
                .text("Add Problem")
            )
        );
      };

      Startup.Binders.placeRoomDismissButton = () => {
        $("#room-actions").append(
          $("<button>")
            .addClass("btn btn-danger btn-sm m-2")
            .text("Dismiss Room")
            .click((event) => {
              socket.emit(RoomDismiss, "");
            })
        );
      };
    </script>

    <!-- Handler -->
    <script>
      Handlers.Problem.create = (event) => {
        event.preventDefault();
        let question = $("#input-new-problem").val();
        question = question.trim();
        if (question === "") {
          alert("You should type any statement");
          return;
        }
        var sampleTestCases = $("#input-problem-test-cases").val();
        $("#input-problem-test-cases").val("");
        if (sampleTestCases === "") {
          sampleTestCases = null;
        } else {
          try {
            sampleTestCases = JSON.parse(sampleTestCases);
          } catch (err) {
            sampleTestCases = null;
          }
        }
        let problem = {
          id: generateRandomString(),
          question: question,
          time: new Date().toLocaleString(),
          sampleTestCases: sampleTestCases,
          author: user.name,
          solutions: [],
        };

        // broadcast this problem
        socket.emit(AddProblem, problem);

        $("#input-new-problem").val("");
      };

      Handlers.Problem.update = (event, problem) => {
        event.preventDefault();
        let updatedQuestion = prompt("Update", problem.question);
        if (updatedQuestion !== null) {
          problem.question = updatedQuestion;
          socket.emit(UpdateProblem, problem);
          alert("Updated");
        }
      };

      Handlers.Problem.solution = (event, problem) => {
        event.preventDefault();
        let code = $(`#${problem.id}-solution-code`).val();
        if (code === "") {
          alert("You must give a piece of code");
          return;
        }
        code = code.trim();
        let lang = $(`#${problem.id}-solution-lang`).val();
        $(`#${problem.id}-solution-code`).val("");

        let solution = {
          code: code,
          lang: lang,
          author: user.name,
          time: new Date().toLocaleString(),
        };
        socket.emit(AddSolution, { problemId: problem.id, solution });
      };
    </script>

    <!-- Component Builders Builders -->
    <script>
      Builders.Form.solution = (problem) => {
        return $("<form>")
          .attr("id", `${problem.id}-solution-form`)
          .submit((event) => Handlers.Problem.solution(event, problem))
          .append(
            $("<textarea>")
              .attr("style", "width:100%;")
              .attr("class", "form-control")
              .attr("placeholder", "Your solution")
              .attr("id", `${problem.id}-solution-code`),

            $("<select>")
              .attr("class", "form-control")
              .attr("id", `${problem.id}-solution-lang`)
              .attr("style", "font-size:12px")
              .append(
                $("<option>").attr("value", "javascript").text("JavaScript"),
                $("<option>").attr("value", "python").text("Python")
              ),

            $("<button>").attr("class", "btn btn-primary btn-sm").text("Submit")
          );
      };

      Builders.Block.sampleCase = (sampleTestCases) => {
        if (sampleTestCases === null) {
          return $("<b>").text("no test case");
        }
        var tableHead = $("<thead>").append(
          $("<tr>").append($("<th>").text("Input"), $("<th>").text("Output"))
        );
        var tableBody = $("<tbody>");
        if (!Array.isArray(sampleTestCases)) {
          tableBody.append(
            $("<tr>").append(
              $("<td>").text(sampleTestCases.input),
              $("<td>").text(sampleTestCases.output)
            )
          );
        } else {
          sampleTestCases.forEach((item) => {
            tableBody.append(
              $("<tr>").append(
                $("<td>").text(item.input),
                $("<td>").text(item.output)
              )
            );
          });
        }

        return $("<table>")
          .addClass("table")
          .attr("style", "font-size:13px;")
          .append(tableHead, tableBody);
      };
    </script>

    <!-- HTML DOM  -->
    <!-- 
    
    ID pattern:
    
    problem-list
    problem-id-${id}
    solutions-${problem_id}
    solution-${solution_id}-${problem_id}
     -->
    <script>
      DOM.Conversation.message = (msg) => {
        let messageBody = msg.body.split("#").join("");
        let fullMessage = markdown(`###### ${msg.username}\n  ${messageBody}`);

        $("#message-list").append($("<li>").html(fullMessage));
        // highlightCode();
      };

      DOM.Peoples.active = (user) => {
        $("#active-user-list").append(
          $("<li>").append(user.name, $("<br>"), $("<span>").text(user.type))
        );
      };

      DOM.Problem.create = (problem) => {
        let card = $("<div>");

        let header = $("<div>")
          .addClass("card-header")
          .append(
            $("<a>")
              .attr("class", "card-link")
              .attr("data-toggle", "collapse")
              .attr("aria-expanded", "false")
              .attr("href", `#${problem.id}`)
              .attr("id", `problem-id-${problem.id}`)
              .text(`${problem.question}`)
          );
        header.append(
          $("<button>")
            .attr("class", "btn btn-sm btn-dark ml-2 disabled")
            .text(`@${problem.author}`)
        );

        if (problem.author === user.name) {
          header.append(
            $("<button>")
              .attr("class", "btn btn-sm btn-primary ml-2")
              .text("edit")
              .click((event) => {
                Handlers.Problem.update(event, problem);
              })
          );
        }

        let solutionForm = Builders.Form.solution(problem);

        let sampleCaseBlock = Builders.Block.sampleCase(
          problem.sampleTestCases
        );
        let body = $("<div>")
          .attr("id", `${problem.id}`)
          .attr("class", "collapse hide")
          .attr("data-parent", "#problem-list")
          .append(
            $("<div>")
              .attr("class", "card-body")
              .append(sampleCaseBlock)
              .append(
                $("<ul>")
                  .attr("class", "list-group")
                  .attr("id", `solutions-${problem.id}`),
                solutionForm
              )
          );
        card.append(header, body);
        $("#problem-list").prepend(card);
      };

      DOM.Problem.solution = (problemId, solution) => {
        let preview = $("<li>")
          .attr("class", "list-group-item")
          .append(
            //Code
            $("<pre>")
              .attr("class", "prettyprint")
              .append(
                $("<code>")
                  .text(solution.code)
                  .attr("class", `language-${solution.lang}`)
              ),
            // Meta
            $("<small>").text(
              `${solution.lang} by ${solution.author} at ${solution.time}`
            ),
            // Executor
            $("<button>")
              .text("Run")
              .attr("class", "btn btn-success btn-sm float-right")
              .click((event) => {
                runCodeScript(solution.lang, solution.code, problemId);
              })
          );

        $(`#solutions-${problemId}`).append(preview);
        highlightCode();
      };

      DOM.Problem.update = (problem) => {
        $(`#problem-id-${problem.id}`).text(`${problem.question}`);
      };
    </script>
  </body>
</html>
